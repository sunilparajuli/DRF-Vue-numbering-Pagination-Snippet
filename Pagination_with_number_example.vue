<template>
  <section class="section is-main-section">
    <div class="tile is-ancestor">
      <div class="tile is-parent">
        <div class="card is-card-widget tile is-child">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon">
                <i class="mdi mdi-arrow-up-bold"></i>
              </span>
              <span>
                <b>384</b> in
                <b>July, 2019</b>
              </span>
            </p>
            <button type="button" class="button is-small">
              <span class="icon">
                <i class="mdi mdi-settings"></i>
              </span>
            </button>
          </header>
          <div class="card-content">
            <div class="level is-mobile">
              <div class="level-item">
                <div class="is-widget-label">
                  <h3 class="subtitle is-spaced">Clients</h3>
                  <h1 class="title">512</h1>
                </div>
              </div>
              <div class="level-item has-widget-icon">
                <div class="is-widget-icon">
                  <span class="icon has-text-primary is-large">
                    <i class="mdi mdi-account-multiple mdi-48px"></i>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tile is-parent">
        <div class="card is-card-widget tile is-child">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon">
                <i class="mdi mdi-arrow-up-bold"></i>
              </span>
              <span>
                <b>$7,000</b> in
                <b>July, 2019</b>
              </span>
            </p>
            <button type="button" class="button is-small">
              <span class="icon">
                <i class="mdi mdi-settings"></i>
              </span>
            </button>
          </header>
          <div class="card-content">
            <div class="level is-mobile">
              <div class="level-item">
                <div class="is-widget-label">
                  <h3 class="subtitle is-spaced">Sales</h3>
                  <h1 class="title">$7,770</h1>
                </div>
              </div>
              <div class="level-item has-widget-icon">
                <div class="is-widget-icon">
                  <span class="icon has-text-info is-large">
                    <i class="mdi mdi-cart-outline mdi-48px"></i>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tile is-parent">
        <div class="card is-card-widget tile is-child">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon">
                <i class="mdi mdi-arrow-down-bold"></i>
              </span>
              <span>
                <b>384%</b> in
                <b>July, 2019</b>
              </span>
            </p>
            <button type="button" class="button is-small">
              <span class="icon">
                <i class="mdi mdi-settings"></i>
              </span>
            </button>
          </header>
          <div class="card-content">
            <div class="level is-mobile">
              <div class="level-item">
                <div class="is-widget-label">
                  <h3 class="subtitle is-spaced">Performance</h3>
                  <h1 class="title">256%</h1>
                </div>
              </div>
              <div class="level-item has-widget-icon">
                <div class="is-widget-icon">
                  <span class="icon has-text-success is-large">
                    <i class="mdi mdi-chart-timeline-variant mdi-48px"></i>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="tile is-parent">
        <div class="card is-card-widget tile is-child">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon">
                <i class="mdi mdi-arrow-down-bold"></i>
              </span>
              <span>
                <b>64</b> in
                <b>July, 2019</b>
              </span>
            </p>
            <button type="button" class="button is-small">
              <span class="icon">
                <i class="mdi mdi-settings"></i>
              </span>
            </button>
          </header>
          <div class="card-content">
            <div class="level is-mobile">
              <div class="level-item">
                <div class="is-widget-label">
                  <h3 class="subtitle is-spaced">Alerts</h3>
                  <h1 class="title">32</h1>
                </div>
              </div>
              <div class="level-item has-widget-icon">
                <div class="is-widget-icon">
                  <span class="icon has-text-danger is-large">
                    <i class="mdi mdi-bell mdi-48px"></i>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card has-table has-mobile-sort-spaced">
      <header class="card-header">
        <p class="card-header-title">
          <span class="icon">
            <i class="mdi mdi-monitor-cellphone"></i>
          </span>
          Responsive Table Sample
        </p>
        <button type="button" class="button is-small">
          <span class="icon">
            <i class="mdi mdi-refresh default"></i>
          </span>
          <span>Refresh</span>
        </button>
      </header>
      <div class="notification is-card-toolbar">
        <div class="level">
          <div class="level-left">
            <div class="level-item">
              <div class="buttons has-addons">
                <button class="button is-active">Active</button>
                <button disabled="disabled" class="button">Recent</button>
                <button disabled="disabled" class="button">Archived</button>
              </div>
            </div>
          </div>
          <div class="level-right">
            <div class="level-item">
              <form>
                <div class="field has-addons">
                  <div class="control">
                    <input type="text" placeholder="Sample field..." class="input" />
                  </div>
                  <div class="control">
                    <button type="submit" class="button is-primary">
                      <span class="icon">
                        <i class="mdi mdi-dots-horizontal default"></i>
                      </span>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div class="card-content">
        <div class="b-table has-pagination">
          <div class="table-wrapper has-mobile-cards">
            <table class="table is-fullwidth is-striped is-hoverable is-fullwidth">
              <thead>
                <tr>
                  <th></th>
                  <th class="is-current-sort is-sortable">
                    <div class="th-wrap">
                      Name
                      <span class="icon is-small">
                        <i class="mdi mdi-arrow-up"></i>
                      </span>
                    </div>
                  </th>
                  <th class="is-sortable">Appoint Date</th>
                  <th class="is-sortable">City</th>
                  <th>Progress</th>
                  <th>Visit ID</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(client, index) in clients" :key="client.id">
                  <td class="is-image-cell">
                    <div class="image">
                      <img
                        src="https://avatars.dicebear.com/v2/initials/rebecca-bauch.svg"
                        class="is-rounded"
                      />
                    </div>
                  </td>
                  <td data-label="Name">{{ client.patient_fullname }}</td>
                  <td data-label="Company">{{ client.appointment_date }}</td>
                  <td data-label="City">{{ index }}</td>
                  <td data-label="Progress" class="is-progress-cell">
                    <progress max="100" class="progress is-small is-primary" value="79">79</progress>
                  </td>
                  <td data-label="Created">
                    <small
                      class="has-text-grey is-abbr-like"
                      title="Oct 25, 2021"
                    >{{ client.visit_id }}</small>
                  </td>
                  <td data-label="Company">{{ client.visit_type }}</td>
                  <td data-label="Company">{{ client.visit_status }}</td>
                  <td class="is-actions-cell">
                    <div class="buttons is-right">
                      <button class="button is-small is-primary" type="button">
                        <span class="icon">
                          <i class="mdi mdi-eye"></i>
                        </span>
                      </button>
                      <button
                        class="button is-small is-danger jb-modal"
                        data-target="sample-modal"
                        type="button"
                      >
                        <span class="icon">
                          <i class="mdi mdi-trash-can"></i>
                        </span>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="notification">
            <div class="level">
              <div class="level-right">
                <div class="level-item">
                  <small>Page {{currentPage}} of {{totalPages}}</small>
                </div>
              </div>

              <div class="pagination">
                <ul class="pagination" v-if="clients.length >= 1 || currentPage > 1">
                  <li class="pagination-item">
                    <button type="button" @click="setPage(1)" :disabled="!showPrevButton">
                      <i class="fas fa-chevron-left"></i>
                      <i class="fas fa-chevron-left"></i>
                    </button>
                  </li>

                  <li class="pagination-item">
                    <button type="button" @click="loadPrev" :disabled="!showPrevButton">
                      <i class="fas fa-chevron-left"></i>
                    </button>
                  </li>

                  <!-- <li class="pagination-item"  v-for="(page, index) in totalPages.slice(startPage, this.endPage)" :key="index"> -->
                    <li class="pagination-item"  v-for="page in pages" :key="page">
                    <button
                      type="button"
                      @click="setPage(page)"
                      :disabled="page.isDisabled"
                      :class="page==currentPage ? 'active' : ''"
                     
                      
                    >{{ page }}</button>
                  </li>

                  <li class="pagination-item">
                    <button type="button" @click="loadNext" :disabled="!showNextButton">
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </li>
                  <li class="pagination-item">
                    <button type="button" @click="setPage(totalPages)" :disabled="!showNextButton">
                      <i class="fas fa-chevron-right"></i>
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</template>
<style lang="scss" scoped>
a {
  color: #999;
}
.current {
  color: red;
}
ul {
  padding: 0;
  list-style-type: none;
}
li {
  display: inline;
  margin: 5px 5px;
}

a.first::after {
  content: "...";
}

a.last::before {
  content: "...";
}
.active {
  color: red;
}
</style>
<script>
import axios from "axios";

import { mapGetters, mapState } from "vuex";
export default {
  name: "Dashboard",
  computed: {
    ...mapGetters([
      "getUserData",
      "getUserToken",
      "getClients",
      "getCounter"
      // ...
    ]),
    ...mapState({
      // clients : 'clients'
    })
  },

  data() {
    return {
      // invoice: {},
      clients: [],
      searchKey: "",
      currentPage: 1,      
      showNextButton: false,
      showPrevButton: false,
      startPage : 1,
      paginateItem : 3,
      endPage : 1,
      totalPages : 1,
      pages : [],

    };
  },
  mounted() {
    this.getVisits();
    
    //this.$store.dispatch("GET_PATIENT_VISIT");
  },

  methods: {
    // getVisits() {
    //     this.clients = $store.state.getters.clients
    // },

    getVisits() {
      axios
        .get(`/api/v2/visits?page=${this.currentPage}`)
        .then(response => {
          this.clients = response.data.results;
          console.log("res", response);
          this.totalPages = response.data.total_pages;
          this.showNextButton = false;
          this.showPrevButton = false;
          if (response.data.next) {
            this.showNextButton = true;
          }

          if (response.data.previous) {
            this.showPrevButton = true;
          }
          this.calcPages();
        })
        .catch(error => {
          console.log(JSON.stringify(error));
        });
    },
    setPage(page) {
      this.currentPage = page;

      // this.currentPage < this.paginateItem ? this.startPage = 1 : this.startPage = this.currentPage - this.paginateItem;
      // this.totalPagess - this.currentPage > 3 ? this.this.endPage = this.currentPage + this.paginateItem : this.this.endPage = this.totalPagess;

      this.getVisits();
    },
    calcPages(){   //Should be written in Computed Property but well
      console.log('calcpages');   
        this.endPage = this.currentPage + this.paginateItem
        if(this.endPage > this.totalPages)
          this.endPage = this.totalPages
        this.startPage = this.currentPage-this.paginateItem
        if (this.startPage < 1)
          this.startPage = 1
        if (this.startPage > this.totalPages)
          this.startPage = this.totalPages                
        var i = this.startPage
        this.pages = []
        while (i<=this.endPage){
          this.pages.push(i)          
          i=i+1
          }
        console.log('pages',this.pages)
        

    },
    loadNext() {
      this.currentPage += 1;
      this.getVisits();
    },
    isPageActive(page) {
      return this.currentPage === page;
    },

    loadPrev() {
      this.currentPage -= 1;
      this.getVisits();
    },
  }
};
</script>